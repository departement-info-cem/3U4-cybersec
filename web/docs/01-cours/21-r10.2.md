---
id: r10.2
title: Rencontre 10.2 - Exploration .exe et d√©compilation
sidebar_label: 10.2 - Exploration .exe et d√©compilation
draft: false
hide_table_of_contents: false
---

## Retour sur l'examen

Nous passerons √† travers l'examen 2 pour donner un correctif √† l'oral. 

Vous pourrez ensuite demander √† revoir votre copie pendant la partie pratique.


## S√©curit√© applicative

Une application est un programme (ou un ensemble de programmes) qui traduit des instructions fornies par l'utilisateur en actions effectu√©es par le syst√®me. Toute application peut contenir des failles de s√©curit√© qui pourraient √™tre exploit√©es par un utilisateur malveillant. De telles failles peuvent se trouver √† plusieurs endroits:
- Dans le **code source** du programme
- Dans sa mani√®re de **stocker** l'information (par exemple, dans une base de donn√©es)
- Dans sa mani√®re de **communiquer** l'information √† un autre syst√®me

Pour trouver des failles √† exploiter, un utilisateur malveillant a plusieurs techniques √† sa disposition. Nous allons en explorer quelques unes.


## L'ing√©nierie inverse

Supposons que le hacker est en contact avec un fichier ex√©cutable. Habituellement, un programme ex√©cutable est compil√© en code machine et donc tr√®s difficile √† lire par un humain, mais ce n'est pas toujours le cas. On peut retrouver trois grandes cat√©gories de fichiers ex√©cutables:

- **Code machine (natif)**: Les langages comme C, C++, Delphi, Rust et Go sont dot√©s de compilateurs dits "natifs" ou "ahead-of-time", qui produisent du code machine directement ex√©cutable par le processeur. Le code compil√© est sp√©cifique √† une architecture pr√©cise de processeur (comme x86-64 ou arm64) ainsi qu'√† un syst√®me d'exploitation (Windows, Linux...) et donc n'est pas portable.
- **Code interm√©diaire (bytecode)**: Les langages comme C#, VB.NET ou Java ne sont pas compil√©s en code machine. √Ä la place, ils sont compil√© en langage interm√©diaire (C# et VB.NET sont compil√©s en MSIL pour CLR, Java est compil√© en bytecode Java pour la JVM). Pour permettre une portabilit√©, ce code est trait√© √† l'ex√©cution par un proc√©d√© nomm√© "compilation Just-In-Time (JIT)", et c'est le framework logiciel qui se charge de traduire ce code en instructions pour le processeur.
- **Code interpr√©t√© (script)**: Finalement, des langages comme JavaScript, PowerShell et bash ne sont pas compil√©s. Le fichier ex√©cutable est en fait un fichier texte qui, lorsque pass√© dans un interpr√©teur, est traduit en instructions pour le syst√®me.

L'ing√©nierie inverse, ou r√©tro-ing√©nierie, c'est l'art de partir du programme ex√©cutable et d'en comprendre le fonctionnement, c'est-√†-dire en lisant le code source. D√©pendant du type d'ex√©cutable, ce proc√©d√© peut √™tre assez difficile.

Les programmes compil√©s natifs sont les plus difficiles √† en d√©duire le code source, car celui-ci est perdu. En d√©compilant (ou en d√©sassemblant) du code natif au moyen d'outils sp√©cialis√©s comme [IDA Pro](https://hex-rays.com/ida-pro), [Ghidra](https://github.com/NationalSecurityAgency/ghidra) et [Cutter](https://cutter.re/), on obtient des instructions de bas niveau, qu'on peut traduire en langage d'assemblage (appel√© Assembleur ou ASM), qui est tr√®s difficile √† comprendre ([Voici un exemple de "Hello World" programm√© en assembleur](https://github.com/nukethebees/github_io/tree/main/hello_world_win_asm)). Certains outils peuvent essayer de convertir ce code dans un langage de plus haut niveau comme le C, mais ce n'est g√©n√©ralement pas tr√®s efficace.

Les programmes compil√©s en code interm√©diaires, bien qu'ils soient souvent des .exe, contiennent du code source dans un langage qui, bien que diff√©rent, peut g√©n√©ralement √™tre restaur√© √† l'aide d'un logiciel de d√©compilation. Les applications .NET (programm√©es en C# ou en Java) peuvent √™tre d√©compil√©es en utilisant des logiciels comme [JetBrains dotPeek](https://www.jetbrains.com/decompiler/) ou [ILSpy (opensource)](https://github.com/icsharpcode/ILSpy). Des produits semblables existent pour Java, comme [Java Decompiler](https://java-decompiler.github.io/).

Les programmes interpr√©t√©s, quant √† eux, ne sont pas compil√©s donc on peut consulter leur code source directement au moyen d'un √©diteur de texte.


## Outils de d√©compilation

### Analyser avec un √©diteur de texte

Premi√®rement, vous pouvez essayer d'ouvrir le fichier exe dans un √©diteur de texte (comme le bloc-notes) pour en reconna√Ætre les cha√Ænes de caract√®res. √Ä travers tout ce charabia, pouvez-vous reconna√Ætre du texte lisible? Chercher le code l√†-dedans est un peu comme chercher une aiguille dans une botte de foin, mais vous pouvez au moins obtenir des indices que ce code est compil√© en .NET pour CLR. En trouvez-vous?


### Ressortir les cha√Ænes de caract√®res

L'outil [Strings](https://learn.microsoft.com/fr-ca/sysinternals/downloads/strings) permet de sortir toutes les cha√Ænes de caract√®res lisibles (ASCII et Unicode). T√©l√©chargez l'outil et sauvegardez-le dans un r√©pertoire sur votre ordinateur (vous aurez besoin de l'extraire du fichier Zip). 

Pour lancer l'outil, vous ne pouvez pas simplement double-cliquer dessus puisqu'il s'agit d'un outil en ligne de commande. D√©marrez un terminal (cmd ou PowerShell) et d√©placez-vous dans le r√©pertoire o√π se trouve l'outil. Puis lancez l'outil avec la syntaxe suivante:

```
.\strings.exe -n 8 "chemin\vers\monSecret.exe" > .\strings.txt
```

L'argument `-n 8` indique qu'on veut extraire les cha√Ænes de 8 caract√®res et plus. Le chemin doit pointer vers le fichier ex√©cutable √† analyser. Finalement, `> .\strings.txt` permet de d√©vier la sortie vers un fichier texte plut√¥t que dans la console.

:::tip
Voici un autre outil int√©ressant: [MiTeC EXE Explorer](https://www.mitec.cz/wp/mee/). Il permet d'obtenir une foule d'informations techniques sur un fichier ex√©cutable. Un de ses onglets permet de lister les cha√Ænes de caract√®res affichables, comme Strings mais en interface graphique. Par contre, on ne peut pas sp√©cifier un nombre de caract√®res. On peut aussi explorer les ressources incluses dans le fichier. Bref, c'est int√©ressant √† essayer. Notez que cet outil n'est gratuit que pour un usage personnel, √©ducatif et non commercial.

![MiTeC EXE Explorer](exeexplorer.png)
:::


### D√©compiler l'application

Sans n√©cessairement trouver toute l'information √† l'aide des outils pr√©c√©dents, nous avons pu d√©terminer qu'il s'agit d'une application .NET. Il y a donc du code interm√©diaire. Nous pouvons tenter de d√©compiler le programme afin de lire le code source en C#. 

On va utiliser **dotPeek** de JetBrains pour d√©compiler l'application:
- Au c√©gep, d√©marrez le logiciel JetBrains Toolbox √† partir du menu D√©marrer et installez DotPeek
- √Ä la maison, [suivez ce lien](https://www.jetbrains.com/decompiler/download/?section=offline-installer) pour t√©l√©charger et installer DotPeek.

:::tip
Il existe d'autres logiciels de d√©compilation DotNet. Le pr√©f√©r√© de Vincent est [ILSpy](https://github.com/icsharpcode/ILSpy). Son mode de fonctionnement est sensiblement le m√™me.
:::


## Pr√©sentation du TP3

Nous allons explorer l'application fournie pour le cours:
- l'application se trouve dans le repo du cours: https://github.com/departement-info-cem/3U4-TP3
- trouvez la section ¬´ Releases ¬ª 
- vous devriez trouver un fichier **consoleApp.exe**

Dans les 4 prochaines semaines, nous allons voir comment on peut attaquer un syst√®me puis le d√©fendre sur 3 aspects:
- le cassage d'un mot de passe sur une BD fuit√©e
- le cassage d'une encryption sur une BD fuit√©e
- l'injection SQL sur l'application (sans BD fuit√©e)

Pour ce TP, vous allez devoir:
- effectuer des attaques sur l'application
- modifier le code pour s√©curiser l'application


---

# Exercices et CTF

## Exercice de d√©compilation

Commencez par t√©l√©charger l'application [MonSecret.exe](https://github.com/departement-info-cem/3U4-cybersec/raw/refs/heads/main/stock/exerciceDecompilation/MonSecret.exe) et tentez de l'ex√©cuter sur votre ordinateur. Le d√©fi est d'analyser le programme pour trouver le code secret.

Ouvrez ensuite le fichier texte dans un √©diteur de votre choix et tentez de trouver le code secret. N'ayez crainte, si vous ne le trouvez pas, nous avons d'autres outils √† notre disposition.

Essayez de d√©compiler l'application fournie avec dotPeek. Il sera plus facile maintenant de non seulement voir le code secret, mais comprendre le fonctionnement de l'application.


## üö© D√©fis CTF - D√©compilation

Les exercices suivants sont des d√©fis de type CTF (Capture The Flag). Vous devez analyser les applications pour trouver les secrets cach√©s et comprendre leur fonctionnement.

### CTF-decomp (1 point)

üìÑ **Fichier de remise**: `ctf-decomp.md`

**Objectif**: Trouver la phrase secr√®te cach√©e dans l'ex√©cutable.

1. T√©l√©chargez l'application [CTF-decomp.exe](https://github.com/departement-info-cem/3U4-cybersec/raw/refs/heads/main/stock/CTF-decomp/CTF-decomp.exe)
2. Lancez l'application - elle vous demande d'entrer un secret
3. Utilisez un d√©compilateur .NET (dotPeek, ILSpy, dnSpy) pour analyser le code
4. Trouvez la phrase secr√®te et entrez-la dans l'application pour valider

:::info Indice
La phrase secr√®te est stock√©e quelque part dans le code... Les d√©veloppeurs font souvent l'erreur de mettre des secrets directement dans leur code source!
:::

**R√©compense**: 1 point au tableau des scores si vous trouvez le secret.

---

### CTF-ecrit-partout (3 points)

üìÑ **Fichier de remise**: `ctf-ecrit-partout.md`

**Objectif**: Cette application de prise de notes semble innocente, mais elle cache vos donn√©es dans des endroits surprenants. Trouvez TOUS les emplacements o√π vos notes sont stock√©es!

1. T√©l√©chargez l'application [CTF-ecrit-partout.exe](https://github.com/departement-info-cem/3U4-cybersec/raw/refs/heads/main/stock/CTF-ecrit-partout/CTF-ecrit-partout.exe)
2. Lancez l'application et cr√©ez quelques notes
3. Utilisez la fonction "Supprimer toutes les notes"
4. **Question**: Vos notes sont-elles vraiment supprim√©es? ü§î

**Votre mission**:
- D√©compilez l'application pour comprendre o√π elle stocke les donn√©es
- Attention: les noms de fichiers sont **obfusqu√©s** dans le code (ASCII, hex, op√©rations sur caract√®res)
- Trouvez les **3 emplacements** o√π les notes sont √©crites:
  1. Un fichier avec un chemin **relatif** qui remonte dans l'arborescence
  2. Un fichier dans le **profil utilisateur**
  3. Un fichier avec un chemin **absolu** Windows

:::warning Attention
M√™me apr√®s avoir "supprim√©" vos notes via l'interface, certains fichiers peuvent rester sur votre disque! C'est un probl√®me de confidentialit√© important.
:::

**R√©compense**: 
- 1 point par emplacement trouv√© (3 points maximum)
- Bonus: Expliquez comment les noms de fichiers sont obfusqu√©s dans le code

:::tip Outils utiles
- Process Monitor pour surveiller les acc√®s fichiers en temps r√©el
- Un d√©compilateur .NET pour lire le code source
- La commande `dir` ou l'explorateur Windows pour v√©rifier si les fichiers existent
:::

---

## Exercices TP3

### Exercice: se familiariser avec l'application

1. T√©l√©chargez l'application compil√©e: https://github.com/departement-info-cem/3U4-TP3/releases/latest
2. Lancez l'application et utilisez-la.
  - cr√©er un compte
  - se connecter / d√©connecter
  - quitter puis la red√©marrer
  - essentiellement tester toutes les possibilit√©s de l'application
3. N'h√©sitez pas √† poser des questions sur l'utilisation de l'application.


### Exercice: bouger l'application

1. Lancer l'application
2. Cr√©er un compte et s'y connecter
3. Fermer l'application
4. D√©placer le .exe dans un dossier diff√©rent
5. Relancer l'application
6. Essayer de se connecter
7. Qu'est-ce qui se passe?


### Partir votre TP

Pour cela, aujourd'hui vous allez devoir:
1. Cr√©er votre repo en utilisant le lien envoy√© par votre prof
2. Cr√©er votre fichier rapport.md o√π vous documenterez les attaques
3. Copier le projet de l'application dans votre repo. C'est l√† que vous mettrez les correctifs.
4. Vous trouverez le projet de l'application [ici](https://github.com/departement-info-cem/3U4-TP3)
